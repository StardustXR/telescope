name: Build AppImage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  APPDIR: StardustXR-Telescope.AppDir
  CARGO_TERM_COLOR: always
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v3

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Install Stardust/Rust dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ pkg-config libfontconfig1-dev libvulkan1 libxkbcommon-dev xwayland libwayland-dev libx11-dev libasound2-dev libxkbcommon-x11-0 libopenxr-dev libxkbcommon-x11-dev libxcb-cursor-dev desktop-file-utils

      - name: Set up Rust (gnu)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          target: x86_64-unknown-linux-gnu

      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/appimagetool/releases/download/1.9.0/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

      - name: Build AppImage
        run: |
          chmod +x build_appimage.sh
          ./build_appimage.sh

      - name: Upload AppDir
        uses: actions/upload-artifact@v4
        with:
          name: Telescope.AppDir
          path: Telescope.AppDir

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Telescope-x86_64.AppImage
          path: Telescope-x86_64.AppImage
